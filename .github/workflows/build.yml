name: Build Installer for Windows and Release

on:
  push:
    tags:
      - '*.*.*'

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Install go-winres
        run: go install github.com/tc-hib/go-winres@latest

      - name: Build Application
        env:
          APP_VERSION: ${{ github.ref_name }}
          GOOS: windows
          GOARCH: amd64
        run: |
          go mod tidy
          go-winres make --product-version=${{ env.APP_VERSION }} --file-version=${{ env.APP_VERSION }}
          go build -ldflags='-H=windowsgui'

      - name: Build Installer
        env:
          APP_NAME: hound
          APP_VERSION: ${{ github.ref_name }}
          APP_PUBLISHER: StorkKershaw
          APP_URL: "${{ github.server_url }}/${{ github.repository }}"
          OUTPUT_DIR: .\
        uses: Minionguyjpro/Inno-Setup-Action@main
        with:
          path: installer.iss
          options: |
            /O+
            /DAppName=${{ env.APP_NAME }}
            /DAppVersion=${{ env.APP_VERSION }}
            /DAppPublisher=${{ env.APP_PUBLISHER }}
            /DAppURL=${{ env.APP_URL }}
            /DOutputDir=${{ env.OUTPUT_DIR }}

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          fail_on_unmatched_files: true
          files: "**/hound v${{ github.ref_name }}.exe"
